var elms=["track","timer","duration","playBtn","pauseBtn","prevBtn","nextBtn","settingBtn","playlistBtn","volumeBtn","progress","waveform","canvas","loading","playlist","list","volume","barEmpty","barFull","sliderBtn"];elms.forEach(function(elm){window[elm]=document.getElementById(elm)});var Player=function(playlist){this.playlist=playlist;do{this.index=Math.floor(Math.random()*playlist.length)}while(null==playlist[this.index].file);track.innerHTML=playlist[this.index].title;for(var indexTemp=this.index-1;null!=this.playlist[indexTemp].file;)--indexTemp;document.getElementById("series").innerHTML=this.playlist[indexTemp].title,changeImage(playlist[this.index].info);var ul=null,ulth=1,pl=document.getElementById("playlist");playlist.forEach(function(song){var li=document.createElement("li");if(li.className="pure-menu-item",null==song.file)null!=ul&&pl.appendChild(ul),li.innerHTML=song.title,li.className+=" pure-menu-disabled playlist-title",(ul=document.createElement("ul")).className="pure-menu-list",ulth>5&&(ul.style.backgroundImage="url('./images/title/"+("00"+ulth).slice(-2)+".jpg')"),ulth++;else{var a=document.createElement("div");a.innerHTML=song.title,a.className="pure-menu-link playlist-item",a.onclick=function(){player.skipTo(playlist.indexOf(song))},li.appendChild(a)}ul.appendChild(li)}),pl.appendChild(ul),gapi.client.setApiKey(googleAPI),gapi.client.load("youtube","v3")};Player.prototype={play:function(index,isNewSong){var self=this,sound;index="number"==typeof index?index:self.index,self.playlist[self.index].howl&&self.index!=index&&(self.playlist[self.index].howl.unload(),delete self.playlist[self.index].howl),self.index=index,console.log("Playing index "+index);var data=self.playlist[index];if(null!=data.file){if(data.howl)sound=data.howl;else{sound=data.howl=new Howl({src:["."+data.file],html5:!0,onplay:function(){duration.innerHTML=self.formatTime(Math.round(sound.duration())),requestAnimationFrame(self.step.bind(self)),pauseBtn.style.display="block"},onload:function(){loading.style.display="none"},onend:function(){self.skip("next")},onpause:function(){},onstop:function(){}});var width=waveform.clientWidth,height=window.innerHeight>0?.2*window.innerHeight:.2*screen.height;if(waveform.style.bottom=.1*height+90+"px",mobilecheck())canvas.style.display="none",waveform.style.opacity=1,wavesurfer&&wavesurfer.destroy(),(wavesurfer=WaveSurfer.create({container:"#waveform",backend:"MediaElement",barWidth:3,cursorColor:"#b556ff",cursorWidth:1,progressColor:"#bf6dff",waveColor:"#e0e0e0"})).load(sound._sounds[0]._node),wavesurfer.on("ready",function(){wavesurfer.play()});else{var accuracy=width<400?16:width<550?32:width<950?64:128;canvas.style.display="block",waveform.style.opacity=.5,wavesurfer&&wavesurfer.destroy(),(vudio=new Vudio(sound._sounds[0]._node,canvas,{effect:"waveform",accuracy:accuracy,width:width,height:height,waveform:{maxHeight:height/10*9,minHeight:1,spacing:4,color:["#ffffff","#e0e0e0"," #c9c9c9"],shadowBlur:1,shadowColor:"#939393",fadeSide:!1,prettify:!1,horizontalAlign:"center",verticalAlign:"bottom"}})).dance()}waveform.style.cursor="pointer";for(var indexTemp=index-1;null!=self.playlist[indexTemp].file;)--indexTemp;document.getElementById("series").innerHTML=self.playlist[indexTemp].title}sound.play(),track.innerHTML=data.title,videoPlayer.stopped||isNewSong?(mvInfo=data.info,mvStage=0):videoPlayer.paused&&videoPlayer.play(),"loaded"===sound.state()?(playBtn.style.display="none",pauseBtn.style.display="block"):(loading.style.display="block",playBtn.style.display="none",pauseBtn.style.display="none")}else self.skip("next")},pause:function(){var self=this,sound;this.playlist[this.index].howl.pause(),videoPlayer.playing&&videoPlayer.pause(),playBtn.style.display="block",pauseBtn.style.display="none"},skip:function(direction){var self=this,index=0;randomPlay.checked?index=Math.floor(Math.random()*this.playlist.length):"prev"===direction?(index=this.index-1)<0&&(index=this.playlist.length-1):(index=this.index+1)>=this.playlist.length&&(index=0),this.skipTo(index)},skipTo:function(index){var self=this;this.playlist[this.index].howl&&this.playlist[this.index].howl.stop(),progress.style.width="0%",progressNow=0,this.play(index,!0)},volume:function(val){var self=this;Howler.volume(val);var barWidth=90*val/100;barFull.style.width=100*barWidth+"%",sliderBtn.style.left=window.innerWidth*barWidth+.05*window.innerWidth-25+"px"},seek:function(per){var self=this,sound=this.playlist[this.index].howl;sound.seek(sound.duration()*per)},step:function(){var self=this,sound=this.playlist[this.index].howl,seek=sound.seek()||0;timer.innerHTML=this.formatTime(Math.round(seek)),progressNow=seek/sound.duration(),progress.style.width=(100*progressNow||0)+"%",requestAnimationFrame(this.step.bind(this))},togglePlaylist:function(){var self=this,display="block"===playlist.style.display?"none":"block";setTimeout(function(){playlist.style.display=display},"block"===display?0:500),playlist.className="block"===display?"pure-menu pure-menu-scrollable fadein":"pure-menu pure-menu-scrollable fadeout"},toggleVolume:function(){var self=this,display="block"===volume.style.display?"none":"block";setTimeout(function(){volume.style.display=display},"block"===display?0:500),volume.className="block"===display?"fadein":"fadeout"},toggleSetting:function(){var self=this,display="block"===setting.style.display?"none":"block";setTimeout(function(){setting.style.display=display},"block"===display?0:500),setting.className="block"===display?"pure-menu fadein":"pure-menu fadeout"},formatTime:function(secs){var minutes=Math.floor(secs/60)||0,seconds=secs-60*minutes||0;return minutes+":"+(seconds<10?"0":"")+seconds}};var songList=[],player,vudio,wavesurfer,resize=function(){var width=waveform.clientWidth,height=window.innerHeight>0?.2*window.innerHeight:.2*screen.height;waveform.style.bottom=.1*height+90+"px",canvas.width=width,canvas.height=height;var sound=player.playlist[player.index].howl;if(sound){var vol,barWidth=.9*sound.volume();sliderBtn.style.left=window.innerWidth*barWidth+.05*window.innerWidth-25+"px",vudio.width=width,vudio.height=height;var space=Math.floor(Math.abs(width-500)/300)+2,accuracy=width<550?32:width<1e3?64:128;vudio.setOption({accuracy:accuracy,waveform:{maxHeight:height/10*9}})}};window.addEventListener("resize",resize);var move=function(event){if(window.sliderDown){var x,startX,layerX=(event.clientX||event.touches[0].clientX)-.05*window.innerWidth,per=Math.min(1,Math.max(0,layerX/parseFloat(barEmpty.scrollWidth)));player.volume(per)}};volume.addEventListener("mousemove",move),volume.addEventListener("touchmove",move),firebase.database().ref("games").once("value").then(function(games){games.val().forEach(game=>{var songObj={};songObj.title=game.name,songObj.file=null,songList.push(songObj),game.songs.forEach(song=>{var songObj={};songObj.title=song.name.split(".")[1]," U"==songObj.title&&(songObj.title=" U.N.オーエンは彼女なのか？"),songObj.file=song.path,songObj.howl=null,songObj.info=song,songList.push(songObj)})}),player=new Player(songList),resize()}),playBtn.addEventListener("click",function(){player.play()}),pauseBtn.addEventListener("click",function(){player.pause()}),prevBtn.addEventListener("click",function(){player.skip("prev")}),nextBtn.addEventListener("click",function(){player.skip("next")}),waveform.addEventListener("click",function(event){player.seek(event.clientX/window.innerWidth)}),playlistBtn.addEventListener("click",function(){player.togglePlaylist()}),playlist.addEventListener("click",function(){player.togglePlaylist()}),volumeBtn.addEventListener("click",function(){player.toggleVolume()}),volume.addEventListener("click",function(){player.toggleVolume()}),closePlaylist.addEventListener("click",function(){player.togglePlaylist()}),settingBtn.addEventListener("click",function(){player.toggleSetting()}),barEmpty.addEventListener("click",function(event){var per=event.layerX/parseFloat(barEmpty.scrollWidth);player.volume(per)}),sliderBtn.addEventListener("mousedown",function(){window.sliderDown=!0}),sliderBtn.addEventListener("touchstart",function(){window.sliderDown=!0}),volume.addEventListener("mouseup",function(){window.sliderDown=!1}),volume.addEventListener("touchend",function(){window.sliderDown=!1});for(var i=6;i<27;i++)imagePreload("./images/title/"+("00"+i).slice(-2)+".jpg");