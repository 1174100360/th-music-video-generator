var progressNow=0;!function(factory){"object"==typeof exports?module.exports=factory():"function"==typeof define&&define.amd?define(factory):window.Vudio=factory()}(function(){"use strict";var __default_option={effect:"waveform",accuracy:128,width:256,height:100,waveform:{maxHeight:80,minHeight:1,spacing:1,color:"#f00",shadowBlur:0,shadowColor:"#f00",fadeSide:!0,horizontalAlign:"center",verticalAlign:"middle",prettify:!0},lighting:{maxHeight:80,lineWidth:0,color:"#f00",shadowBlur:0,shadowColor:"#f00",fadeSide:!0,horizontalAlign:"center",verticalAlign:"middle"}};function Vudio(audioSource,canvasElement,option){if(-1===["[object HTMLAudioSource]","[object HTMLAudioElement]","[object MediaStream]"].indexOf(Object.prototype.toString.call(audioSource)))throw new TypeError("Invaild Audio Source");if("[object HTMLCanvasElement]"!==Object.prototype.toString.call(canvasElement))throw new TypeError("Invaild Canvas Element");this.audioSrc=audioSource,this.canvasEle=canvasElement,this.option=__mergeOption(__default_option,option),this.meta={},this.stat=0,this.freqByteData=null,this.__init()}function __mergeOption(){var __result={};return Array.prototype.forEach.call(arguments,function(argument){var __prop,__value;for(__prop in argument)Object.prototype.hasOwnProperty.call(argument,__prop)&&("[object Object]"===Object.prototype.toString.call(argument[__prop])?__result[__prop]=__mergeOption(__result[__prop],argument[__prop]):__result[__prop]=argument[__prop])}),__result}return Vudio.prototype={__init:function(){var audioContext=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),source="[object MediaStream]"!==Object.prototype.toString.call(this.audioSrc)?audioContext.createMediaElementSource(this.audioSrc):audioContext.createMediaStreamSource(this.audioSrc),dpr=window.devicePixelRatio||1;this.analyser=audioContext.createAnalyser(),this.meta.spr=audioContext.sampleRate,source.connect(this.analyser),this.analyser.fftSize=2*this.option.accuracy,this.analyser.connect(audioContext.destination),this.freqByteData=new Uint8Array(this.analyser.frequencyBinCount),this.context2d=this.canvasEle.getContext("2d"),this.width=this.option.width,this.height=this.option.height,this.context2d.canvas.width=this.width*dpr,this.context2d.canvas.height=this.height*dpr,this.context2d.scale(dpr,dpr)},__rebuildData:function(freqByteData,horizontalAlign){var __freqByteData;return __freqByteData="center"===horizontalAlign?[].concat(Array.from(freqByteData).reverse().splice(this.option.accuracy/2,this.option.accuracy/2),Array.from(freqByteData).splice(0,this.option.accuracy/2)):"left"===horizontalAlign?freqByteData:"right"===horizontalAlign?Array.from(freqByteData).reverse():[].concat(Array.from(freqByteData).reverse().splice(this.option.accuracy/2,this.option.accuracy/2),Array.from(freqByteData).splice(0,this.option.accuracy/2))},__animate:function(){1===this.stat&&(this.analyser.getByteFrequencyData(this.freqByteData),"function"==typeof this.__effects()[this.option.effect]&&this.__effects()[this.option.effect](this.freqByteData),requestAnimationFrame(this.__animate.bind(this)))},__testFrame:function(){this.analyser.getByteFrequencyData(this.freqByteData),"function"==typeof this.__effects()[this.option.effect]&&this.__effects()[this.option.effect](this.freqByteData)},__effects:function(){var __that=this;return{lighting:function(freqByteData){var __lightingOption=__that.option.lighting,__freqByteData=__that.__rebuildData(freqByteData,__lightingOption.horizontalAlign),__maxHeight=__lightingOption.maxHeight/2,__isStart=!0,__fadeSide=!0,__x,__y;"center"!==__lightingOption.horizontalAlign&&(__fadeSide=!1),__that.context2d.clearRect(0,0,__that.width,__that.height),__that.context2d.lineWidth=__lightingOption.lineWidth,__that.context2d.strokeStyle=__lightingOption.color,__that.context2d.beginPath(),__freqByteData.forEach(function(value,index){__x=__that.width/__that.option.accuracy*index,__y=value/256*__maxHeight,__y="middle"===__lightingOption.verticalAlign?(__that.height-value)/2-__maxHeight/2:"bottom"===__lightingOption.verticalAlign?__that.height-value:"top"===__lightingOption.verticalAlign?value:(__that.height-value)/2-__maxHeight/2,__isStart?(__that.context2d.moveTo(__x,__y),__isStart=!1):__that.context2d.lineTo(__x,__y)}),__that.context2d.stroke()},waveform:function(freqByteData){var __waveformOption=__that.option.waveform,__fadeSide=__waveformOption.fadeSide,__prettify=__waveformOption.prettify,__freqByteData=__that.__rebuildData(freqByteData,__waveformOption.horizontalAlign),__maxHeight,__width,__height,__left,__top,__color,__linearGradient,__pos;"center"!==__waveformOption.horizontalAlign&&(__fadeSide=!1,__prettify=!1),__that.context2d.clearRect(0,0,__that.width,__that.height);var reflection=.2;__freqByteData.forEach(function(value,index){if(__width=(__that.width-__that.option.accuracy*__waveformOption.spacing)/__that.option.accuracy,__left=index*(__width+__waveformOption.spacing),1!==__waveformOption.spacing&&(__left+=__waveformOption.spacing/2),__maxHeight=__prettify?index<=__that.option.accuracy/2?(1-(__that.option.accuracy/2-1-index)/(__that.option.accuracy/2))*__waveformOption.maxHeight:(1-(index-__that.option.accuracy/2)/(__that.option.accuracy/2))*__waveformOption.maxHeight:__waveformOption.maxHeight,__height=(__height=value/256*__maxHeight*.8)<__waveformOption.minHeight?__waveformOption.minHeight:__height,__top="middle"===__waveformOption.verticalAlign?(__that.height-__height)/2:"top"===__waveformOption.verticalAlign?0:"bottom"===__waveformOption.verticalAlign?.8*__that.height-__height:(__that.height-__height)/2,__color=__waveformOption.color,index<=Math.floor(__freqByteData.length*progressNow)){__linearGradient=__that.context2d.createLinearGradient(__left,__top,__left,__top+__height);var color_temp=["#c477ff","#bf6dff"," #b556ff"];color_temp.forEach(function(color,index){__pos=0===index||index===color_temp.length-1?index/(color_temp.length-1):index/color_temp.length+.5/color_temp.length,__linearGradient.addColorStop(__pos,color)}),__that.context2d.fillStyle=__linearGradient}else __color instanceof Array?(__linearGradient=__that.context2d.createLinearGradient(__left,__top,__left,__top+__height),__color.forEach(function(color,index){color instanceof Array?(__pos=color[0],color=color[1]):__pos=0===index||index===__color.length-1?index/(__color.length-1):index/__color.length+.5/__color.length,__linearGradient.addColorStop(__pos,color)}),__that.context2d.fillStyle=__linearGradient):__that.context2d.fillStyle=__color;__waveformOption.shadowBlur>0&&(__that.context2d.shadowBlur=__waveformOption.shadowBlur,__that.context2d.shadowColor=__waveformOption.shadowColor),__fadeSide?index<=__that.option.accuracy/2?__that.context2d.globalAlpha=1-(__that.option.accuracy/2-1-index)/(__that.option.accuracy/2):__that.context2d.globalAlpha=1-(index-__that.option.accuracy/2)/(__that.option.accuracy/2):__that.context2d.globalAlpha=1,__that.context2d.fillRect(__left,__top,__width,__height)}),__freqByteData.forEach(function(value,index){if(__width=(__that.width-__that.option.accuracy*__waveformOption.spacing)/__that.option.accuracy,__left=index*(__width+__waveformOption.spacing),1!==__waveformOption.spacing&&(__left+=__waveformOption.spacing/2),__maxHeight=__prettify?index<=__that.option.accuracy/2?(1-(__that.option.accuracy/2-1-index)/(__that.option.accuracy/2))*__waveformOption.maxHeight:(1-(index-__that.option.accuracy/2)/(__that.option.accuracy/2))*__waveformOption.maxHeight:__waveformOption.maxHeight,__height=(__height=value/256*__maxHeight*.2)<__waveformOption.minHeight?__waveformOption.minHeight:__height,__top=.8*__that.height,__color=__waveformOption.color,index<=Math.floor(__freqByteData.length*progressNow)){__linearGradient=__that.context2d.createLinearGradient(__left,__top,__left,__top+__height);var color_temp=["#c477ff","#bf6dff"," #b556ff"];color_temp.forEach(function(color,index){__pos=0===index||index===color_temp.length-1?index/(color_temp.length-1):index/color_temp.length+.5/color_temp.length,__linearGradient.addColorStop(__pos,color)}),__that.context2d.fillStyle=__linearGradient}else __color instanceof Array?(__linearGradient=__that.context2d.createLinearGradient(__left,__top,__left,__top+__height),__color.forEach(function(color,index){color instanceof Array?(__pos=color[0],color=color[1]):__pos=0===index||index===__color.length-1?index/(__color.length-1):index/__color.length+.5/__color.length,__linearGradient.addColorStop(__pos,color)}),__that.context2d.fillStyle=__linearGradient):__that.context2d.fillStyle=__color;__waveformOption.shadowBlur>0&&(__that.context2d.shadowBlur=__waveformOption.shadowBlur,__that.context2d.shadowColor=__waveformOption.shadowColor),__fadeSide?index<=__that.option.accuracy/2?__that.context2d.globalAlpha=1-(__that.option.accuracy/2-1-index)/(__that.option.accuracy/2):__that.context2d.globalAlpha=1-(index-__that.option.accuracy/2)/(__that.option.accuracy/2):__that.context2d.globalAlpha=1,__that.context2d.globalAlpha=.2,__that.context2d.fillRect(__left,__top,__width,__height)})}}},dance:function(){return 0===this.stat&&(this.stat=1,this.__animate()),this},pause:function(){return this.stat=0,this},setOption:function(option){this.option=__mergeOption(this.option,option)}},Vudio});